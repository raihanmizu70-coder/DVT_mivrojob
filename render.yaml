version: "1"
services:
  # Main Backend API Service
  - type: web
    name: dvt-backend
    env: python
    region: singapore
    plan: free
    rootDir: backend
    buildCommand: pip install -r requirements.txt && python database.py
    startCommand: gunicorn app:app --workers 2 --worker-class uvicorn.workers.UvicornWorker --bind 0.0.0.0:$PORT --timeout 120
    healthCheckPath: /api/health
    autoDeploy: true
    envVars:
      # Database
      - key: DATABASE_URL
        fromDatabase:
          name: dvt_database
          property: connectionString
      
      # Telegram
      - key: TELEGRAM_BOT_TOKEN
        value: 8506336833:AAHqTala7chpEiJJ2W1s6lSN5qgwdJpC5b8
      - key: TELEGRAM_ADMIN_ID
        value: 6561117046
      - key: ADMIN_TELEGRAM_USERNAME
        value: "@Miju132"
      
      # Admin Access
      - key: ADMIN_PASSWORD
        value: Mizu123@@
      - key: ADMIN_USERNAME
        value: admin
      
      # Cloudinary
      - key: CLOUDINARY_CLOUD_NAME
        sync: false
      - key: CLOUDINARY_API_KEY
        value: 764846719658924
      - key: CLOUDINARY_API_SECRET
        value: OmdiuCF8
      
      # App Configuration
      - key: APP_NAME
        value: "DVT Mini App"
      - key: APP_ENV
        value: production
      - key: SECRET_KEY
        generateValue: true
      - key: JWT_SECRET
        generateValue: true
      
      # URLs
      - key: WEB_APP_URL
        sync: false
      - key: SITE_URL
        sync: false
      
      # Server
      - key: PORT
        value: 8000
      - key: WORKERS
        value: 2
      - key: LOG_LEVEL
        value: info
      
      # Features
      - key: ENABLE_REGISTRATION
        value: "true"
      - key: ENABLE_WITHDRAWAL
        value: "true"
      - key: ENABLE_REFERRAL
        value: "true"
      - key: MIN_WITHDRAWAL
        value: "100"
      - key: REFERRAL_BONUS
        value: "5"

  # Frontend Static Site
  - type: web
    name: dvt-frontend
    env: static
    region: singapore
    plan: free
    rootDir: frontend
    buildCommand: echo "Building frontend..."
    staticPublishPath: .
    routes:
      - type: rewrite
        source: /api/*
        destination: https://dvt-backend.onrender.com/api/*
      - type: rewrite
        source: /admin/*
        destination: https://dvt-backend.onrender.com/admin/*
    envVars:
      - key: API_URL
        value: https://dvt-backend.onrender.com
      - key: TELEGRAM_BOT_USERNAME
        value: "@digitalvishon_1235bot"
    headers:
      - path: /*
        name: Cache-Control
        value: public, max-age=3600
      - path: /*
        name: Access-Control-Allow-Origin
        value: "*"

  # Telegram Bot Worker (Optional)
  - type: worker
    name: dvt-telegram-bot
    env: python
    region: singapore
    plan: free
    rootDir: telegram-bot
    buildCommand: pip install -r requirements.txt
    startCommand: python bot.py
    envVars:
      - key: TELEGRAM_BOT_TOKEN
        value: 8506336833:AAHqTala7chpEiJJ2W1s6lSN5qgwdJpC5b8
      - key: TELEGRAM_ADMIN_ID
        value: 6561117046
      - key: BACKEND_URL
        value: https://dvt-backend.onrender.com
      - key: ADMIN_PASSWORD
        value: Mizu123@@

  # Cron Jobs for Maintenance
  - type: cron
    name: dvt-cleanup
    schedule: "0 3 * * *"  # Daily at 3 AM
    env: python
    region: singapore
    plan: free
    rootDir: backend
    buildCommand: pip install -r requirements.txt
    startCommand: python scripts/cleanup.py
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: dvt_database
          property: connectionString

databases:
  - name: dvt_database
    plan: free
    region: singapore
    databaseName: dvt_database
    user: dvt_user
    ipAllowList: []
    # Initial data
    initScript: |
      CREATE TABLE IF NOT EXISTS users (
          id SERIAL PRIMARY KEY,
          telegram_id BIGINT UNIQUE NOT NULL,
          username VARCHAR(100),
          first_name VARCHAR(100),
          balance DECIMAL(10,2) DEFAULT 0.00,
          cash_wallet DECIMAL(10,2) DEFAULT 0.00,
          refer_code VARCHAR(50) UNIQUE NOT NULL,
          referred_by VARCHAR(50),
          created_at TIMESTAMP DEFAULT NOW()
      );
      
      CREATE TABLE IF NOT EXISTS micro_jobs (
          id SERIAL PRIMARY KEY,
          task_id VARCHAR(50) UNIQUE NOT NULL,
          title VARCHAR(200) NOT NULL,
          description TEXT NOT NULL,
          cpa_link TEXT NOT NULL,
          amount DECIMAL(10,2) NOT NULL,
          status VARCHAR(20) DEFAULT 'active',
          max_submissions INTEGER DEFAULT 100,
          daily_limit INTEGER DEFAULT 3,
          admin_id INTEGER DEFAULT 1,
          created_at TIMESTAMP DEFAULT NOW()
      );
      
      CREATE TABLE IF NOT EXISTS task_submissions (
          id SERIAL PRIMARY KEY,
          user_id INTEGER,
          task_id VARCHAR(50) NOT NULL,
          screenshot_url TEXT NOT NULL,
          status VARCHAR(20) DEFAULT 'pending',
          admin_review TEXT,
          amount DECIMAL(10,2) NOT NULL,
          created_at TIMESTAMP DEFAULT NOW()
      );
      
      CREATE TABLE IF NOT EXISTS withdrawals (
          id SERIAL PRIMARY KEY,
          user_id INTEGER,
          amount DECIMAL(10,2) NOT NULL,
          net_amount DECIMAL(10,2) NOT NULL,
          charges DECIMAL(10,2) NOT NULL,
          method VARCHAR(50) NOT NULL,
          account_number VARCHAR(100) NOT NULL,
          status VARCHAR(20) DEFAULT 'pending',
          is_first_withdrawal BOOLEAN DEFAULT TRUE,
          created_at TIMESTAMP DEFAULT NOW()
      );
      
      -- Insert admin user
      INSERT INTO users (telegram_id, username, first_name, refer_code) 
      VALUES (6561117046, 'Miju132', 'Admin', 'ADMIN-001') 
      ON CONFLICT (telegram_id) DO NOTHING;
      
      -- Insert sample tasks
      INSERT INTO micro_jobs (task_id, title, description, cpa_link, amount) VALUES
      ('MJ-001', 'Sign up for ABC Platform', 'Complete registration on ABC Platform', 'https://example.com/task1', 3.00),
      ('MJ-002', 'Install Mobile App', 'Download and install our app', 'https://example.com/task2', 5.00),
      ('MJ-003', 'Complete Survey', 'Answer a few questions', 'https://example.com/task3', 4.00)
      ON CONFLICT (task_id) DO NOTHING;

# Disk and Resource Configuration
disk:
  name: data
  mountPath: /data
  sizeGB: 1

# Build and Deploy Settings
buildFilter:
  paths:
    - backend/**
    - frontend/**
    - telegram-bot/**
    - render.yaml
  ignoredPaths:
    - node_modules/**
    - __pycache__/**
    - .git/**

# Notifications (Optional)
notifications:
  - type: slack
    channel: deployments
    events:
      - deploy_succeeded
      - deploy_failed
  - type: email
    address: your-email@example.com
    events:
      - deploy_failed
